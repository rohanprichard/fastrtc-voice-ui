<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastRTC Voice Widget Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .demo-section {
            margin: 40px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .widget-container {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }
    </style>
    <script src="./dist/fastrtc-voice-widget.umd.js"></script>
</head>
<body>
    <h1>FastRTC Voice Widget Test Page</h1>

    <div class="demo-section">
        <h2>Basic Widget</h2>
        <p>This widget features a large, centered button with text below. Replace <code>https://your-api.com</code> with your actual WebRTC endpoint.</p>

        <div class="widget-container">
            <fastrtc-voice-widget api-url="http://localhost:8000"></fastrtc-voice-widget>
        </div>

        <h3>HTML Code:</h3>
        <pre><code>&lt;fastrtc-voice-widget api-url="https://your-api.com"&gt;&lt;/fastrtc-voice-widget&gt;</code></pre>
    </div>

    <div class="demo-section">
        <h2>Widget with Device Selection</h2>
        <p>This widget includes device selection controls in the top-right corner.</p>

        <div class="widget-container">
            <fastrtc-voice-widget api-url="http://localhost:8000" show-device-selection></fastrtc-voice-widget>
        </div>

        <h3>HTML Code:</h3>
        <pre><code>&lt;fastrtc-voice-widget api-url="https://your-api.com" show-device-selection&gt;&lt;/fastrtc-voice-widget&gt;</code></pre>
    </div>

    <div class="demo-section">
        <h2>Widget with Authentication</h2>
        <p>This widget includes an authentication token for secure API access.</p>

        <div class="widget-container">
            <fastrtc-voice-widget api-url="http://localhost:8000" auth-token="demo-token" show-device-selection></fastrtc-voice-widget>
        </div>

        <h3>HTML Code:</h3>
        <pre><code>&lt;fastrtc-voice-widget api-url="https://your-api.com" auth-token="your-token" show-device-selection&gt;&lt;/fastrtc-voice-widget&gt;</code></pre>
    </div>

    <div class="demo-section">
        <h2>Connected State Demo</h2>
        <p>This shows what the widget looks like when connected (with expanded controls).</p>

        <div class="widget-container">
            <fastrtc-voice-widget api-url="http://localhost:8000" show-device-selection is-connected></fastrtc-voice-widget>
        </div>

        <h3>HTML Code:</h3>
        <pre><code>&lt;fastrtc-voice-widget api-url="https://your-api.com" show-device-selection is-connected&gt;&lt;/fastrtc-voice-widget&gt;</code></pre>
    </div>

    <div class="demo-section">
        <h2>Instructions</h2>
        <ol>
            <li><strong>IMPORTANT: Load the script in the &lt;head&gt; section</strong> (not at the bottom of the page):
                <pre><code>&lt;head&gt;
    &lt;script src="https://unpkg.com/fastrtc-voice-widget@1.0.0/dist/fastrtc-voice-widget.js"&gt;&lt;/script&gt;
&lt;/head&gt;</code></pre>
            </li>
            <li><strong>Add the widget element</strong> where you want it to appear on your page</li>
            <li><strong>Configure the api-url</strong> attribute with your WebRTC backend URL</li>
            <li><strong>Optional:</strong> Add <code>show-device-selection</code> to enable device selection menu</li>
            <li><strong>Optional:</strong> Add <code>auth-token</code> if your API requires authentication</li>
            <li><strong>Demo:</strong> Add <code>is-connected</code> to show the connected state with expanded controls</li>
        </ol>

        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0;">
            <h4 style="color: #92400e; margin-top: 0;">‚ö†Ô∏è Important Note:</h4>
            <p style="color: #92400e; margin-bottom: 0;">
                The script <strong>must be loaded in the &lt;head&gt; section</strong> before the browser parses the custom elements.
                If you see just text instead of the widget, the script is loading too late.
            </p>
        </div>
    </div>

    <div class="demo-section">
        <h2>üîä Audio Debug</h2>
        <p>If you're not hearing audio output, use these debugging tools:</p>
        <div style="margin: 10px 0;">
            <button onclick="debugAudio()" style="margin: 5px; padding: 10px 20px;">Debug Audio Status</button>
            <button onclick="testAudioPlayback()" style="margin: 5px; padding: 10px 20px; background: #fbbf24;">Test Audio Playback</button>
        </div>
        <div id="audio-debug" style="background: #f3f4f6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px;"></div>

        <script>
            function testAudioPlayback() {
                const testAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IAAAAAEAAQARAAAAEAAAAAEACABkYXRhAgAAAAEA');
                testAudio.volume = 0.5;
                testAudio.play().then(() => {
                    alert('‚úÖ Audio playback test successful! Your browser can play audio.');
                }).catch(error => {
                    alert('‚ùå Audio playback test failed: ' + error.message);
                });
            }
        </script>

        <p><strong>Common Audio Issues:</strong></p>
        <ul>
            <li><strong>Check console:</strong> Open browser dev tools (F12) and check for audio-related messages</li>
            <li><strong>Check connection:</strong> Make sure WebRTC is connected before expecting audio</li>
            <li><strong>Check permissions:</strong> Microphone permissions must be granted for device enumeration</li>
            <li><strong>Check browser:</strong> Some browsers require user interaction before playing audio</li>
            <li><strong>Server endpoint:</strong> Make sure your server has a `/webrtc/offer` endpoint that accepts the offer and ICE candidates</li>
            <li><strong>CORS:</strong> Check if there are any CORS issues preventing the requests</li>
        </ul>

        <p><strong>Expected Console Messages:</strong></p>
        <ul>
            <li>‚úÖ "Attaching remote stream to audio element"</li>
            <li>‚úÖ "Remote audio started playing"</li>
            <li>‚úÖ "Audio element unmuted"</li>
            <li>‚úÖ "Remote description (answer) set."</li>
            <li>üîä "Remote track received: audio"</li>
            <li>üéµ "Audio track detected"</li>
            <li>üîó "Attaching remote audio stream to audio element"</li>
            <li>üîä "Audio stream attached, element configured"</li>
            <li>üîÑ "Attempting to play audio after stream attachment..."</li>
            <li>‚úÖ "Initial audio play successful"</li>
            <li>‚úÖ "Data channel opened - treating as WebRTC connected"</li>
            <li>‚úÖ "ICE connected - treating as WebRTC connected"</li>
            <li>üîä "Force unmute attempt completed"</li>
        </ul>

        <p><strong>Server Response Format Expected:</strong></p>
        <ul>
            <li>Your server should return: <code>{ "sdp": "...", "type": "answer" }</code></li>
            <li>Server response is wrapped in RTCSessionDescription object</li>
            <li>Proper validation of server response format</li>
        </ul>

        <p><strong>Audio Debugging Steps:</strong></p>
        <ol>
            <li><strong>Connect the widget</strong> and watch for connection messages</li>
            <li><strong>Check for remote tracks</strong> - Look for "üîä Remote track received: audio"</li>
            <li><strong>Verify stream attachment</strong> - Look for "üîó Attaching remote audio stream"</li>
            <li><strong>Check audio playback</strong> - Look for "‚úÖ ‚úÖ Remote audio started playing"</li>
            <li><strong>If no audio, run debug</strong> - Click "Debug Audio Status" and check the console output</li>
        </ol>

        <p><strong>Implementation Notes:</strong></p>
        <ul>
            <li>Proper TURN credentials from GET /webrtc/turn-credentials</li>
            <li>Server response validation and error handling</li>
            <li>RTCSessionDescription object creation from server response</li>
            <li>Better error messages with server response debugging</li>
            <li><strong>Enhanced Connection Detection:</strong> Now detects connection via ICE state, data channel messages, or connection state</li>
            <li><strong>Force Audio Unmuting:</strong> Multiple techniques to bypass browser autoplay restrictions</li>
            <li><strong>User Interaction Workaround:</strong> Click anywhere on the widget to enable audio if autoplay fails</li>
        </ul>

        <p><strong>Connection Detection Logic:</strong></p>
        <ul>
            <li><strong>Data Channel Messages:</strong> When you see data channel messages like "started_talking", the widget will automatically mark as connected and unmute audio</li>
            <li><strong>ICE Connection:</strong> When ICE connection state becomes "connected" or "completed", the widget will mark as connected and unmute audio</li>
            <li><strong>Connection State:</strong> Standard WebRTC connection state detection as fallback</li>
        </ul>

        <p><strong>Force Audio Unmuting:</strong></p>
        <ul>
            <li><strong>Multiple Techniques:</strong> Direct property setting, output device control, and retry playback</li>
            <li><strong>Triggered Automatically:</strong> When connection is detected via any method above</li>
            <li><strong>User Interaction Fallback:</strong> Click anywhere on the widget if audio still doesn't work</li>
            <li><strong>Console Logging:</strong> Look for "üîä Force unmute attempt completed" and "‚úÖ Final audio element state"</li>
            <li><strong>Play Interruption Fix:</strong> Avoids the "play() request was interrupted" error by carefully managing play calls</li>
        </ul>

        <p><strong>Play Request Interruption Fix:</strong></p>
        <ul>
            <li><strong>Problem:</strong> Multiple play() calls can interrupt each other, causing "AbortError"</li>
            <li><strong>Solution:</strong> Only call play() when audio is paused and has a stream attached</li>
            <li><strong>Result:</strong> Eliminates the "media was removed from document" error</li>
        </ul>

        <script>
            function debugAudio() {
                const widgets = document.querySelectorAll('fastrtc-voice-widget');
                const debugDiv = document.getElementById('audio-debug');

                if (widgets.length === 0) {
                    debugDiv.innerHTML = '‚ùå No widgets found on page';
                    return;
                }

                debugDiv.innerHTML = 'üîç Checking audio status...\n\n';

                widgets.forEach((widget, index) => {
                    debugDiv.innerHTML += `Widget ${index + 1}:\n`;
                    debugDiv.innerHTML += `  - Connected: ${widget.isWebRTCConnected || 'Not connected'}\n`;
                    debugDiv.innerHTML += `  - Audio element: ${widget.audioOutputElement ? '‚úÖ Found' : '‚ùå Missing'}\n`;

                    if (widget.audioOutputElement) {
                        debugDiv.innerHTML += `  - Audio muted: ${widget.audioOutputElement.muted}\n`;
                        debugDiv.innerHTML += `  - Audio volume: ${widget.audioOutputElement.volume}\n`;
                        debugDiv.innerHTML += `  - Audio srcObject: ${widget.audioOutputElement.srcObject ? '‚úÖ Has stream' : '‚ùå No stream'}\n`;
                        debugDiv.innerHTML += `  - Audio readyState: ${widget.audioOutputElement.readyState}\n`;
                    }

                    debugDiv.innerHTML += '\n';
                });

                // Also call the debug method if available
                if (widgets[0] && widgets[0].debugAudioStatus) {
                    console.log('Calling debugAudioStatus method...');
                    widgets[0].debugAudioStatus();
                }
            }
        </script>
    </div>

    <div class="demo-section">
        <h2>Widget Design</h2>
        <p>The widget features a modern, centered design with:</p>
        <ul>
            <li><strong>Large 80px button</strong> with sophisticated shadows and hover effects</li>
            <li><strong>Centered text</strong> below the button with clear status messages</li>
            <li><strong>Smooth animations</strong> for state transitions</li>
            <li><strong>Accessible design</strong> with proper ARIA labels and screen reader support</li>
        </ul>
    </div>

    <div class="demo-section">
        <h2>Widget States</h2>
        <p>The widget has three main states:</p>
        <ul>
            <li><strong>Idle:</strong> Plain/neutral colored button with "Click to start voice chat"</li>
            <li><strong>Connecting:</strong> Orange pulsing animation with "Connecting..."</li>
            <li><strong>Connected:</strong> Red button with expanded controls (hang up + mute)</li>
        </ul>
        <p>When connected, the widget expands to show additional controls:
        <ul>
            <li><strong>Call button</strong> (plain/neutral) - starts connection</li>
            <li><strong>Hang up button</strong> (red) - ends the connection</li>
            <li><strong>Mute button</strong> (plain when not muted, yellow when muted) - toggles microphone</li>
        </ul>
        </p>
    </div>

    <div class="demo-section">
        <h2>Device Selection</h2>
        <p>If enabled with <code>show-device-selection</code>, users can:</p>
        <ul>
            <li>Click the settings icon (‚öôÔ∏è) positioned in the top-right corner of the widget</li>
            <li>Choose from all available microphones and speakers</li>
            <li>Changes apply in real-time during calls</li>
        </ul>
        <p><strong>Features:</strong></p>
        <ul>
            <li><strong>Permission on-demand:</strong> Device access is requested only when settings is clicked</li>
            <li><strong>Hidden audio with autoplay:</strong> Remote audio plays automatically through hidden element</li>
            <li><strong>Robust device enumeration:</strong> Handles permission denials and missing devices gracefully</li>
            <li>Lists all available input (microphone) devices with clear names</li>
            <li>Lists all available output (speaker) devices with clear names</li>
            <li>Real-time device switching during active calls</li>
            <li><strong>Vertically centered settings button:</strong> Perfectly positioned in the middle of the widget</li>
        </ul>
        <p><strong>Note:</strong> The first time you click the settings button, it will request microphone permissions. If permissions are denied, it will show default/placeholder devices.</p>
    </div>

</body>
</html>

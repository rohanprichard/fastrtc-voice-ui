<!DOCTYPE html>
<html>
    <head>
        <title>FastRTC Voice Widget Test Page</title>
        <script>

// pass any rtc_configuration params here
const pc = new RTCPeerConnection();
const base_url = "http://localhost:8000";
                     
async function setupWebRTC(peerConnection) {
    const audio_output_component = document.getElementById("audio_output_component_id");
    if (!audio_output_component) {
        console.error("Audio element not found");
        return;
    }
          
    // Get audio stream from webcam
    const stream = await navigator.mediaDevices.getUserMedia({
        audio: true,
    })
    
    
    //  Send audio stream to server
    stream.getTracks().forEach(async (track) => {
        const sender = pc.addTrack(track, stream);
    })
    
    
    peerConnection.addEventListener("track", (evt) => {
        if (evt.streams && evt.streams[0]) {
            if (audio_output_component.srcObject !== evt.streams[0]) {
                audio_output_component.srcObject = evt.streams[0];
                const playPromise = audio_output_component.play();
                if (playPromise !== undefined) {
                    playPromise.catch((e) => console.warn("Audio play failed (will likely succeed after user gesture):", e));
                }
            }
        }
    });
    
    // Create data channel (needed!)
    const dataChannel = peerConnection.createDataChannel("text");

    // Create and send offer
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    let webrtc_id = Math.random().toString(36).substring(7)

    // Send ICE candidates to server
    // (especially needed when server is behind firewall)
    peerConnection.onicecandidate = ({ candidate }) => {
        if (candidate) {
            console.debug("Sending ICE candidate", candidate);
            fetch(`${base_url}/webrtc/offer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                candidate: candidate.toJSON(),
                webrtc_id: webrtc_id,
                type: "ice-candidate",
                    })
                })
            }
    };

    // Send offer to server
        const response = await fetch(`${base_url}/webrtc/offer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sdp: offer.sdp,
            type: offer.type,
            webrtc_id: webrtc_id
        })
    });

    // Handle server response
    const serverResponse = await response.json();
    await peerConnection.setRemoteDescription(serverResponse);
}

        </script>

    </head>
    <body>
        <h1>FastRTC Voice Widget Test Page</h1>
        <button onclick="setupWebRTC(pc)">Setup WebRTC</button>
        <audio id="audio_output_component_id" autoplay playsinline></audio>
    </body>
</html>